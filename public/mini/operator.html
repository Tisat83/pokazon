<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>mini operator</title>

  <!-- Мы в iframe, нужна только панель оператора -->
  <script>
    window.POKAZON_EMBED = true;
    window.POKAZON_ONLY  = 'operator';
    if (location.hash !== '#operator') { location.replace(location.pathname + '#operator'); }
  </script>

  <!-- Лоадер (версию меняем для сброса кэша) -->
  <script defer src="/src/oko-loader.js?v=embed8"></script>

  <style>
    /* ===== тот же демо-фон и прокрутка, что и у клиента ===== */
    html, body { height: 100%; }
    body{
      margin:0;
      background-image: url('/assets/screen2.jpg');
      background-repeat: no-repeat;
      background-position: top center;
      background-size: 100% auto;
      overflow-y: auto;
      padding-bottom: 1200px; /* чтобы был заметный скролл */
    }

    /* компактный вид панели */
    html.oko-mini-compact .oko-panel { max-width: 420px !important; }
    .oko-mini-collapsed .oko-mini-body { display: none !important; }

    /* на всякий случай прячем «Лог» */
    .oko-hide-log [data-oko-log],
    .oko-hide-log .oko-log,
    .oko-hide-log button.oko-log,
    .oko-hide-log a.oko-log { display: none !important; }

    /* сама панель — фиксируем у нижнего правого края, чтобы не закрывала фон */
    .oko-panel{
      position: fixed !important;
      right: 18px; bottom: 18px;
      z-index: 2147483001; /* выше кнопок */
    }
  </style>
</head>
<body>

<script>
/* Урезаем панель: оставляем только поле кода + «Войти».
   Экран клиента/Твой экран/Подогнать/Автоподгон/Сброс/якоря/стрелки/лог — скрываем. */
(function () {
  const DEADLINE = Date.now() + 10000;
  function norm(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
  function text(el){ return norm(el.textContent); }

  function shrink() {
    const panel = Array.from(document.querySelectorAll('div,section,aside'))
      .find(n => /панель оператора/i.test((n.textContent||'')));
    if (!panel) { if (Date.now() < DEADLINE) requestAnimationFrame(shrink); return; }

    document.documentElement.classList.add('oko-mini-compact','oko-hide-log');

    // Шапка панели — показываем «крестик» справа
    const header = Array.from(panel.querySelectorAll('div,header,h1,h2,h3'))
      .find(h => /панель оператора/i.test((h.textContent||''))) || panel;
    const closeBtn = header.querySelector('button, a, .close, .oko-close') ||
                     panel.querySelector('button[aria-label="Close"], [data-oko-close]');
    if (closeBtn) {
      closeBtn.style.display = '';
      closeBtn.style.marginLeft = 'auto';
    }

    // Тело
    let body = panel.querySelector('.oko-mini-body');
    if (!body) {
      body = document.createElement('div');
      body.className = 'oko-mini-body';
      Array.from(panel.children).forEach(ch => { if (ch!==header) body.appendChild(ch); });
      panel.appendChild(body);
    }

    // Поле кода и кнопка «Войти»
    const codeInput = Array.from(panel.querySelectorAll('input,textarea'))
      .find(el => /код/.test(norm(el.placeholder)));
    const joinBtn = Array.from(panel.querySelectorAll('button, a'))
      .find(el => text(el)==='войти');

    if (!codeInput || !joinBtn) {
      if (Date.now() < DEADLINE) requestAnimationFrame(shrink);
      return;
    }

    // Список того, что скрываем
    const hideContains = [
      'только указка','синхронная прокрутка','подогнать','автоподгон','сброс',
      'окно wxh','окно w×h','якорь','перейти','pgup','pgdn','top','bottom','лог',
      'экран клиента','твой экран'
    ];

    Array.from(body.querySelectorAll('*')).forEach(el => {
      const keep = el===codeInput || el===joinBtn ||
                   (el.contains && (el.contains(codeInput)||el.contains(joinBtn)));
      if (keep) return;
      const t = text(el);
      if (hideContains.some(key => t.includes(key))) {
        el.style.display = 'none';
        el.setAttribute('data-mini-hidden','1');
      }
    });

    // Перерисовки — повторяем урезание
    const mo = new MutationObserver(() => shrink());
    mo.observe(panel, { childList:true, subtree:true });
  }

  window.addEventListener('load', shrink);
  setTimeout(shrink, 400);
  setTimeout(shrink, 1000);
  setTimeout(shrink, 2000);
})();
</script>
<script>
/** уменьшение шага прокрутки в мини-демо (картинка) */
(function () {
  // 0.3 = 30% от системного шага; сделайте 0.2–0.35 как вам удобно
  const FACTOR = 0.30;

  // что крутим: либо спец-обёртка, либо сам документ
  const scroller =
    document.querySelector('.demo-scroll, .scroll, .frame, .page') ||
    document.scrollingElement || document.documentElement;

  // колесо
  function onWheel(e) {
    if (e.ctrlKey) return;           // не мешаем zoom по Ctrl+колесо
    e.preventDefault();              // берём прокрутку на себя
    scroller.scrollTop += e.deltaY * FACTOR;
  }
  window.addEventListener('wheel', onWheel, { passive: false });

  // PgUp / PgDn / стрелки (опционально)
  window.addEventListener('keydown', function (e) {
    const h = window.innerHeight;
    if (e.key === 'PageDown') { e.preventDefault(); scroller.scrollTop += h * FACTOR; }
    if (e.key === 'PageUp')   { e.preventDefault(); scroller.scrollTop -= h * FACTOR; }
    if (e.key === 'ArrowDown'){ e.preventDefault(); scroller.scrollTop += 60 * FACTOR; }
    if (e.key === 'ArrowUp')  { e.preventDefault(); scroller.scrollTop -= 60 * FACTOR; }
  });
})();
</script>

</body>
</html>
