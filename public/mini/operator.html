<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>mini operator</title>

  <script>
    // режим встраивания и принудительный хеш
    window.POKAZON_EMBED = true;
    window.POKAZON_ONLY  = 'operator';
    if (location.hash !== '#operator') { location.replace(location.pathname + '#operator'); }
  </script>

  <!-- лоадер (новый cache-bust) -->
  <script defer src="/src/oko-loader.js?v=embed4"></script>

  <style>
    /* немного ужмём панель визуально */
    .oko-mini-compact .oko-panel,
    .oko-mini-compact [class*="panel"][class*="oko"] {
      max-width: 420px !important;
    }
  </style>
</head>
<body>

<script>
/* Мини-оператор: оставить только поле кода и кнопку «Войти» */
(function () {
  function compactify() {
    // ищем контейнер панели по заголовку
    var panel = Array.from(document.querySelectorAll('div,section,aside'))
      .find(function(n){ return /ОКО\s*·\s*Панель оператора/i.test(n.textContent || ''); });
    if (!panel) return;

    // пометим body — пригодится для CSS
    document.documentElement.classList.add('oko-mini-compact');

    // найдём необходимые элементы
    var codeInput = Array.from(panel.querySelectorAll('input,textarea'))
      .find(function(el){ return /код/i.test((el.placeholder || '')); });
    var joinBtn = Array.from(panel.querySelectorAll('button, a'))
      .find(function(el){ return /^войти$/i.test((el.textContent || '').trim()); });

    // если не нашли — выходим, подождём следующую мутацию
    if (!codeInput || !joinBtn) return;

    // прячем всё внутри панели, кроме заголовка, поля кода и кнопки «Войти»
    Array.from(panel.querySelectorAll('*')).forEach(function(el){
      var keep =
        el === codeInput ||
        el === joinBtn ||
        el.contains && (el.contains(codeInput) || el.contains(joinBtn)) ||
        /панель оператора/i.test((el.textContent || ''));

      if (!keep) {
        el.style.display = 'none';
      }
    });

    // добавим в шапку «свернуть» (–)
    var header = Array.from(panel.querySelectorAll('div,h1,h2,h3,header')).find(function(h){
      return /панель оператора/i.test((h.textContent || ''));
    });
    if (header && !header.querySelector('[data-mini-collapse]')) {
      var btn = document.createElement('button');
      btn.textContent = '–';
      btn.setAttribute('data-mini-collapse','');
      btn.style.cssText = 'margin-left:auto; padding:4px 10px; border-radius:10px; cursor:pointer;';
      btn.onclick = function(){
        var body = panel; // сворачиваем всё, что под шапкой (мы уже всё скрыли, но оставим поведение)
        if (body.getAttribute('data-collapsed') === '1') {
          body.setAttribute('data-collapsed','0');
          Array.from(panel.querySelectorAll('*')).forEach(function(el){
            if (el.style && el.getAttribute('data-mini-hidden') === '1') el.style.display = '';
          });
        } else {
          body.setAttribute('data-collapsed','1');
          Array.from(panel.querySelectorAll('*')).forEach(function(el){
            if (el === codeInput || el === joinBtn || el.contains(codeInput) || el.contains(joinBtn)) return;
            if (el.style) { el.style.display = 'none'; el.setAttribute('data-mini-hidden','1'); }
          });
        }
      };
      header.style.display = 'flex';
      header.style.alignItems = 'center';
      header.appendChild(btn);
    }
  }

  // Пробуем сразу и подписываемся на мутации (панель отрисовывается асинхронно)
  compactify();
  var mo = new MutationObserver(function(){ compactify(); });
  mo.observe(document.documentElement, { childList:true, subtree:true });
  // на всякий случай ещё пара попыток
  setTimeout(compactify, 400);
  setTimeout(compactify, 1200);
})();
</script>

</body>
</html>
