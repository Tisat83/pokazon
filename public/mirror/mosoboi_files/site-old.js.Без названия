$(document).ready(function () {
	if ($('.wrap-404').length == 0 && $('.home-slider').length == 0)
	$("#content_part").css("min-height", $(window).height() - $("#top-panel").height() - $("#header").height() - $("#menu_t").height() + 20 + "px");

	$('.side-buttons').delay(3000).removeClass('hidden');

	/* Маска телефона -s */
	/*$('input[data-type="phone"]').inputmask("+7-999-999-99-99", {
	 "onincomplete": function(){
	 $(this).val('');
	 var placeholder = $(this).attr('data-placeholder');
	 $(this).attr('placeholder', placeholder);
	 }}
	 );*/
	/* Маска телефона -f */

	/* фиксированная шапка */
	if ($(".header_fixed_block").length > 0) {
		var $nav = $("#menu_t"),
			$window = $(window),
			$h = $nav.offset().top,
			$fixedBlock = $(".header_fixed_block");

		$window.scroll(function () {
			// Если прокрутили скролл ниже макушки блока, включаем фиксацию
			if ($window.scrollTop() > $h) {
				$fixedBlock.addClass("top_fixed_block");
			} else {
				//Иначе возвращаем всё назад
				$fixedBlock.removeClass("top_fixed_block");
				$nav.removeClass("top_fixed_block_menu");
			}
		});
	}

	$("body").on("click", ".js_header_fixed_block_items-menu", function(){
        $("#menu_t").toggleClass("top_fixed_block_menu");
	});

	$(".fancybox").fancybox({
		helpers: {overlay: {locked: false}},
		beforeShow: function() {
			let imageTitle = $(this.element).find("img").attr("title");
			if (imageTitle) {
				$('.fancybox-image').attr('title', imageTitle);
				$('.fancybox-image').attr('alt', imageTitle);
			}
		}
		// tpl: {
		// 	image: '<img class="fancybox-image" src="{href}" alt="' + this.title + '" />',
		// },
		// afterLoad : function(instance, current) {
		// 	console.log($(this.element));
		// 	// current.$image.attr('alt', current.opts.$orig.find('img').attr('alt'));
		// }
	});
	$(".fb").fancybox({helpers: {overlay: {locked: false}}});

	$(document).click(function (event) {
		if ($(event.target).closest('.vspliv_tov').length == 0 && $(event.target).attr('class') != 'product_image') {
			$('.overlay').remove();
			$('div.product_image .prod-popup').css('display', 'none');
		}
	});

	$(".pforms").colorbox({
		className: 'pforms',
		initialWidth: 0,
		initialHeight: 0,
		onOpen: function () {
			$("#cboxClose").css({opacity: 0});
		},
		onComplete: function () {
			$("#cboxClose").stop().animate({opacity: 1});
		}
	});

	dWidth = $(document).width();

	// tc
	function getCookie(name) {
		var matches = document.cookie.match(new RegExp(
			"(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
		));
		return matches ? decodeURIComponent(matches[1]) : undefined;
	}

	CurrentCity();
	function CurrentCity(cityId, callback) {
		//console.log(cityId);
		if (cityId == undefined) cityId = 0;
		$.ajax({
			url: '/ajax/result/current_city.php',
			data: {'id': cityId},
			dataType: 'json',
			success: function (data) {
				$('#tcShowCity span').text(data.name);
				$('#tcCityPrice').text(data.price);
				$('#you-region').text(data.name);
				var show_youreg = getCookie("cookie_youreg");
				var show_youreg_BXSM = getCookie("BITRIX_SM_cookie_youreg");
//				if (show_youreg != "Y")
//					$('.you-region-popup').show();
				if (show_youreg_BXSM != "Y")
					$('.you-region-popup').show();
				if (data.id == 152679) {
					$('#phone-for-region').hide();
					//$('.header-phone .header-phone-link:first').css("margin-top","8px");
					$('.js_for_region').hide();
					$('.reg-footer-phone').hide();
					$('.reg-footer-phone-text').hide();

					//console.log('1');
				}
				else {
					$('#phone-for-region').show();
					$('.js_for_region').show();
					$('.reg-footer-phone').show();
					$('.reg-footer-phone-text').show();

					//console.log('2');

				}
				$("#tcShowCity a").attr('href', '/ajax/view/city.php?id=' + data.id);
				if (callback) callback();
				//window.location.reload();
			}
		});
	}



	$(document).on("click", "#popupCity .col a", function () { // клик по городу
		$("#popupCity .col a").removeClass('active');
		$(this).addClass('active');
		CurrentCity($(this).attr('data-id'), function () {
			$('#colorbox').colorbox.close();
			window.location.reload();
		});
	});
	$(document).on("click", "#popupCity .chars a", function () { // клик по букве города
		var scrollTo = false; // в мобильной версии скроллим страницу к городу
		$("#popupCity .chars a").removeClass('active');
		$(this).addClass('active');
		letter = $(this).text();
		$('#popupCity .col a').each(function (i, el) {
			// console.log(letter, $(el).text().substring(0, 1));
			if ($.trim($(el).text()).substring(0, 1) != letter) {
				$(el).addClass('disable');
			} else {
				$(el).removeClass('disable');
				if (!scrollTo) scrollTo = $(el).offset().top;
			}
		})
		if (dWidth <= 1200) $('html, body').animate({scrollTop: scrollTo - 50}, 'slow');
	});

	$(".you-region-yes").click(function (event) {
		$.cookie('cookie_youreg', 'Y', {expires: 365, path: '/'});
		$.cookie('BITRIX_SM_cookie_youreg', 'Y', {expires: 365, path: '/'});
		$('.you-region-popup').hide();
		// return false;
	});


	$(document).on('click', ".quick2order", function () {
		//console.log($(this).closest('.i_info').find('.current_price').text().trim());
		let productPrice = $(this).closest('.i_info').find('.current_price').text().trim();
		if (productPrice.length == 0)
			productPrice = $(this).closest('.block-element').find('.cat-item-buy-block-price').text().trim();
		if (productPrice.length == 0)
			productPrice = $(this).attr('data-element-price');

		productPrice = productPrice.replace(/[^0-9]/g, '');
		var data = {
			'productId': $(this).attr('data-element-id'),
			'productName': $(this).attr('data-element-name'),
			'productPrice': productPrice //$(this).attr('data-element-price')
		};
//		if($('.product-detail').length > 0)
		if($('.product-detail').length > 0 && $(this).closest('#smartUpdate').length<=0)
		{
			data['detail'] = 'Y';
			data['url'] = $('.product-detail').attr('data-url');
			data['name'] = $('h1').text();
			$('#colorbox').css('border', '0');
		}
		if(window.location.search=='?task'){
			data['task'] = '.';
		}
		$.colorbox({
			href: '/ajax/form/quick_order.php',
			data: data,
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
				yaGoalsFunction.event7();

				// $('#quickOrderForm form input[name=phone]').val(7).inputmasks(
				// 	$.extend(true, {}, maskOpts, {
				// 		list: listCountries
				// 	})
				// );
			}
		});
		return false;
	});

    $(document).on('click', ".buy_credit", function () {
		var data = {
			'productId': $(this).attr('data-element-id'),
			'productName': $(this).attr('data-element-name'),
			'productPrice': $(this).attr('data-element-price')
		};
		if($('.product-detail').length > 0)
		{
			data['detail'] = 'Y';
			data['url'] = $('.product-detail').attr('data-url');
			data['name'] = $('h1').text();
			$('#colorbox').css('border', '0');
		}
		if($('.js_color_block').length)
		{
			data['product_type'] = 'paint';
			data['color_id'] = $('.js_color_id').val();
			data['color_name'] = $('.js_color_name').html();
			data['color_code'] = $('.js_color_code').html();
		}
        $.colorbox({
            href: '/ajax/form/loan_applications.php',
            data: data,
            className: 'pforms',
            initialWidth: 0,
            initialHeight: 0,
            onOpen: function () {
                $("#cboxClose").css({opacity: 0});
            },
            onComplete: function () {
                $("#cboxClose").stop().animate({opacity: 1});
                yaGoalsFunction.event19();
            }
        });
        return false;
    });

	// $(".spec_it").click(function () {
	// 	$.colorbox({
	// 		href: '/ajax/form/specprice_order.php',
	// 		data: {
	// 			'productURL': $(this).attr('data-url'),
	// 		},
	// 		className: 'pforms',
	// 		initialWidth: 0,
	// 		initialHeight: 0,
	// 		onOpen: function () {
	// 			$("#cboxClose").css({opacity: 0});
	// 		},
	// 		onComplete: function () {
	// 			$("#cboxClose").stop().animate({opacity: 1});
	// 		}
	// 	});
	// });

	$(document).on('click', '.spec_it', function(e) {
		$.colorbox({
			href: '/ajax/form/specprice_order.php',
			data: {
				'productURL': e.currentTarget.dataset.url || '',
			},
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
			}
		});
	});

	$(document).on("click",".how_much_is_this .js_link",function () {
		return '';
		$.colorbox({
			href: '/ajax/form/howmuchisthis.php',
			data: {
				'element_id': $(this).attr('data-element-id'),
				'element_name': $(this).attr('data-element-name'),
				'element_url': $(this).attr('data-element-url'),
			},
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
			}
		});
	});

	$(".callback2order").click(function () {
		$.colorbox({
			href: '/ajax/form/callback_order.php',
			data: {},
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
			}
		});
	});

	$(".find-error__button").click(function () {
		$.colorbox({
			href: '/ajax/form/find_error.php',
			data: {},
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
				//console.log('clcknashlioshibku');
				yaGoals.send('clcknashlioshibku');
			}
		});
	});

	$('.product-card__admin-button').click(function() {
        let button = $(this);
		let type = button.attr('data-type');

		if (type == 'product_problem') {
			$.colorbox({
				href: '/ajax/form/product_problem.php',
				data: {
					type: $(this).attr('data-type'),
					url: $(this).attr('data-url')
				},
				className: 'pforms',
				initialWidth: 0,
				initialHeight: 0,
				onOpen: function () {
					$("#cboxClose").css({opacity: 0});
				},
				onComplete: function () {
					$("#cboxClose").stop().animate({opacity: 1});
				}
			});
		} else if (type == 'not_produced') {
			$.ajax({
			    url: '/ajax/result/product_admin_message.php',
			    method: 'post',
			    dataType: 'json',
			    data: {
			        type: $(this).attr('data-type'),
			        url: $(this).attr('data-url')
			    },
			    success: function(response) {
			        //console.log(response);
			        if (response.result == 'ok') {
			            button.addClass('success');
			            button.html('Сообщение отправлено');
			            button.attr('disabled', true);
			        } else {
			            //console.log(response);
			        }

			    }
			});
		}
    });

	$(".js_obrazec_button").click(function () {
		$.colorbox({
			href: '/ajax/form/obrazec_order.php',
			data: {
				'id':$(this).closest('.js_obrazec_block').find('.product_id').val(),
				'brand':$(this).closest('.js_obrazec_block').find('.product_brand').val(),
				'collection':$(this).closest('.js_obrazec_block').find('.product_collection').val()
			},
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
			}
		});
	});
	$(".showroom_callback2order").click(function () {
		var roistat_code = $(this).attr('data-roistat-code');
		$.colorbox({
			href: '/ajax/form/showroom_callback_order.php',
			data: {roistat_code: roistat_code},
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
				$('#showroom_callbackOrderForm').find('input[name="form_name"]').val(`Обратный звонок на странице шоу-рума ${$('.showroom-name').html()}`);
			}
		});
	});
	$(".showroom2order").click(function () {
		var roistat_code = $(this).attr('data-roistat-code');
		$.colorbox({
			href: '/ajax/form/showroom_order.php',
			data: {roistat_code: roistat_code},
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
				$('#showroomOrderForm').find('input[name="form_name"]').val(`Бронирование купона ${$('.showroom-name').html()}`);
			}
		});
	});

	if (window.location.href.includes('coop-new')) {
		$(".js_designer_form").click(function (e) {
			$.get("/ajax/form/designer_order_new.php", function (formHtml) {
				const formWrapper = document.createElement('div');
				formWrapper.classList.add('popup-form-wrapper');
				formWrapper.innerHTML = formHtml;

				formWrapper.addEventListener('click', (e) => {
					if (e.currentTarget == e.target)
						e.currentTarget.remove()
				});

				document.body.append(formWrapper);

				console.log(formWrapper.querySelector('.cooperation-form-container').offsetHeight);
				let formContainer = formWrapper.querySelector('.cooperation-form-container');
				formContainer.style.height = formContainer.offsetHeight + 'px';

				cooperationForm.init();
			});
		});

		const cooperationForm = {
			init: () => {
				const popupFormWrapper = document.querySelector('.popup-form-wrapper');
				const variants = popupFormWrapper.querySelectorAll('.form-variant');
				variants.forEach((variant) => {
					variant.addEventListener('click', (e) => {
						e.currentTarget.closest('.cooperation-form-container').querySelectorAll('._active')
							.forEach((item) => item.classList.remove('_active'));

						e.currentTarget.classList.add('_active');
						popupFormWrapper.querySelector(`.variant-content[data-id="${e.currentTarget.dataset.id}"]`).classList.add('_active');
					});
				});

				const closeFormBtn = popupFormWrapper.querySelector('.form-close-btn');
				closeFormBtn.addEventListener('click', (e) => {
					e.currentTarget.closest('.popup-form-wrapper').remove();
				});

				const form = popupFormWrapper.querySelector('#cooperation-form');

				if (!form) return;

				form.addEventListener('submit', (e) => {
					e.preventDefault();

					cooperationForm.showPreloader();

					const formData = new FormData(e.currentTarget);

					fetch('https://www.mosoboi.ru/ajax/result/designer_order_result.php', {
						method: 'POST',
						body: formData,
					})
						.then(response => response.json())
						.then(json => {
							cooperationForm.hidePreloader();
							if (json.errors && json.errors.length > 0) {
								json.errors.forEach((errorField) => {
									form.querySelector(`input[name="${errorField}"]`).classList.add('error');
								});
							} else if (json.result) {
								popupFormWrapper.remove();

								$.get("/ajax/form/designer_order_new.php?success", function (html) {
									const formWrapper = document.createElement('div');
									formWrapper.classList.add('popup-form-wrapper');
									formWrapper.innerHTML = html;

									formWrapper.addEventListener('click', (e) => {
										if (e.currentTarget == e.target)
											e.currentTarget.remove()
									});

									setTimeout(() => {formWrapper.remove()}, 3000);

									document.body.append(formWrapper);

									cooperationForm.init();
								});
							}
						});
				});

				$('#cooperation-form input[name=phone]').mask("+7 999 999 99 99");
				$('#cooperation-form input[name=phone]').on('focus click',function(){
					$(this)[0].setSelectionRange(3, 3);
				});
			},
			showPreloader: () => {
				$('.popup-form-wrapper .preloader').addClass('show');
			},
			hidePreloader: () => {
				$('.popup-form-wrapper .preloader').removeClass('show');
			}
		}
	} else {
		$(".js_designer_form").click(function () {
			$.colorbox({
				href: '/ajax/form/designer_order.php',
				data: {},
				className: 'pforms',
				initialWidth: 0,
				initialHeight: 0,
				onOpen: function () {
					$("#cboxClose").css({opacity: 0});
				},
				onComplete: function () {
					$("#cboxClose").stop().animate({opacity: 1});
				}
			});
		});
	}


	$(".footer .compliant-form").on('click', function () {
		ym(15883444, 'reachGoal', 'clckzhaloba');
		$.colorbox({href: '/ajax/form/complaint_form.php',className: 'complaint_form'});
	});
	if($('.js_top_submenu_banner').length>0){
		$(".js_top_submenu_banner").on('click', function () {
			ym(15883444, 'reachGoal', 'clck-bpodbor-krasok');
			$.colorbox({href: '/ajax/form/top_submenu_banner.php',className: 'complaint_form'});
		});
	}

	$('.side-banner-kraski').click(function() {
		ym(15883444, 'reachGoal', 'click-kolerovka');
	});

	$('.i-info').mouseover(function () {
		$('.inform-popup').fadeIn();
	});
	$('.i-info').mouseout(function () {
		$('.inform-popup').fadeOut();
	});

    $("#top-panel .top-panel-menu-toggle").click(function () {
        $("#top-panel").removeClass("opened-search");
        if ($("#top-panel").hasClass('opened-menu')) {
            $("#top-panel").removeClass("opened-menu");
            $('.mobile-multilevel-menu').hide();
            $('.mobile-multilevel-menu').find('li.open').children('ul').hide();
            $("#top-panel").find('li').removeClass("open");
        } else {
            $("#top-panel").addClass("opened-menu");
			$('.top-panel-menu').css('height', ($(document).height() - 60) + 'px');
        }
    });
	$(".top-panel-menu").click(function (e) {
		if (e.target == this) {
			$('.top-panel-menu-toggle').trigger('click');
		}
	});
	$("#top-panel .search-toggle").click(function () {
		$("#top-panel").removeClass("opened-menu");
		if ($("#top-panel").hasClass('opened-search')) $("#top-panel").removeClass("opened-search");
		else $("#top-panel").addClass("opened-search");
	});

	$(document)
		.on("click", ".add2basket", function () {
			var id = $(this).attr('data-element-id');
			var quantity = ($(this).parents('form').length > 0)
					? parseInt($(this).parents('form').find('.basket_kolvo').val())
					: parseInt($(this).parents('.sale-block').find('.basket_kolvo').val());

			if (isNaN(quantity)) {
				quantity = $(this).parent().siblings('.quantity').find('.basket_kolvo').val();
			}

			if (isNaN(quantity)) {
				quantity = $(this).closest('.js_add2basket_popup').find('.js_count_input').val();
				quantity = parseInt(quantity);

				if(quantity>1){
					//quantity -= 1;
				}

			}


			if (isNaN(quantity)) {
				quantity = $(this).closest('.js_item').find('.js_count_input').html();
			}


			var ecommerce = $(this).parents('.product-item-wrap').find('.ecommerce-info');

			if(ecommerce)
			{
				var name = ecommerce.attr('data-name');
				var brand = ecommerce.attr('data-brand');
				var category = ecommerce.attr('data-category');
				var price = ecommerce.attr('data-price');
				var ecommersKey = 0;

				var productObj = {
					"id": id,
					"name": name,
					"price": price,
					"brand": brand,
					"category": category,
					"quantity": quantity ? quantity : 1
				};
				var ecommerceObj = {
					"products": [
						productObj
					]
				};
				if((typeof window.dataLayer)==="undefined")
					window.dataLayer = [];

				for(var i = 0; i < window.dataLayer.length; i++)
				{
					if(window.dataLayer[i].ecommerce)
						ecommersKey = window.dataLayer[i].ecommerce;
				}

				if(ecommersKey && ecommersKey.add)
				{
					ecommersKey.add.products.push(productObj)
				}
				else
				{
					if(ecommersKey)
					{
						ecommersKey.add = ecommerceObj;
					}
					else
					{
						window.dataLayerYa.push({
							"currencyCode": "RUB",
							"ecommerce": {
								"add": {
									"products": [
										productObj
									]
								}
							}
						});
					}
				}
			}

			let calculatedQuantity = $(this).closest('.collect_div').find('.calculated-quantity__input').val();
			//console.log(calculatedQuantity);

			if (calculatedQuantity !== undefined) {
				Add2Basket(id, calculatedQuantity, 'A2B', calculatedQuantity);
			} else {
				Add2Basket(id, quantity, 'A2B');
			}

			// if (!$(this).hasClass('disabled'))
			// 	Add2Basket(id, quantity, 'A2B');

			if (window.location.pathname == '/personal/cart/'/* && document.cookie.includes('new_order=y')*/) {
				setTimeout(() => {
					$.ajax({
						url: '/personal/cart/',
						type: 'get',
						dataType: 'html',
						success: function(response) {
							$('.cart-wrapper').html($(response).find('.cart-wrapper').html());
							$('#smartUpdate').html($(response).find('#smartUpdate').html());

							if (basketRelatedList) {
								basketRelatedList.sliderInit();
							}
						}
					});
				}, 1000);
			}

			return false;
		})
		.on("click", ".js-form-add-new-order", function () {
			var interval = setInterval(function () {
				if($(".errortext").length > 0) {
                    if($(".errortext .js-user-is-already-registered").length > 0){
                        yaGoalsFunction.event20();
					}
					clearInterval(interval);
				}
            }, 1000)
        });

	function Add2Basket(id, quantity, action, calculatedQuantity = null) {
		if(isNaN(quantity))
			quantity = 1;
		$.ajax({
			url: '/ajax/result/add2basket.php',
			type: 'post',
			dataType: 'json',
			data: {
				'action': action,
				'id': id,
				'quantity': quantity
			},
			beforeSend: function (data) {
				$("#ediv-preloader-" + id).show();
				$('.ediv-preloader-fast').show(); // затеняем корзину в избранном
			},
			error: function (data) {
				console.error(data);
			},
			success: function (data) {
				$("#ediv-preloader-" + id).hide();
				$('.ediv-preloader-fast').hide();
				if (data['status']) {
					if($('.product-detail').length > 0)
					{
						data['detail'] = 'Y';
						data['data']['url'] = $('.product-detail').attr('data-url');
						data['data']['name'] = $('h1').text();
						$('#colorbox').css('border', '0');
					}
//console.log(data);

					if(window.location.search=='?test'){
						data['test'] = '.';
					}
					if(window.location.search=='?task'){
						data['task'] = '.';
					}
					if(window.location.search=='?new_basket'){
						data['new_basket'] = '.';
					}

					if (calculatedQuantity !== null)  {
						data['calculated_quantity'] = calculatedQuantity;
					}

					data['window_width'] = $(window).width();

					data['city'] = $('[data-role="header-city"]').text();

					if (window.location.pathname !== '/personal/cart/'/* || !document.cookie.includes('new_order=y')*/) {

						$.colorbox({
							href: '/ajax/view/add2basket_popup.php',
							className: 'pforms',
							initialWidth: 0,
							initialHeight: 0,
							data: data,
							width: ($(window).width() < 1000) ? ($(window).width() - 20) + 'px' : false,
							onOpen: function () {
								$("#cboxClose").css({opacity: 0});
							},
							onComplete: function () {
								$("#cboxClose").stop().animate({opacity: 1});
								$.colorbox.resize();

								if (popupCartSoputSuggestion)
									popupCartSoputSuggestion.init();
							}
						});

					}

					$.get("/ajax/view/basket_top.php", function (smallBasketHtml) {
						$("#basket-top").html(smallBasketHtml);

                        var countBasketItems = $("#basket-top .basket-info .count span").text();

                        if(!$(".header_fixed_block_items-basket a img").hasClass("background_elliplse")) {
                            $(".header_fixed_block_items-basket a img")
                                .addClass("background_elliplse")
                                .attr("src", "/bitrix/templates/mosoboi_ad/images/header_fixed_block/have_numbers_basket.png");
                            $(".header_fixed_block_items-basket a").append("<div class='count'>" + countBasketItems + "</div>");
						} else {
                            $(".header_fixed_block_items-basket a .count").text(countBasketItems);
						}

					});
					$.get("/ajax/view/basket_top_new.php", function (smallBasketNewHtml) {
						$(".header-cart").html(smallBasketNewHtml);

						if($('.header-cart .header-cart-count').length){
							var cart_count = $('.header-cart .header-cart-count').html();
							$('#header_scroll .is_cart_count').html(cart_count);

							var cart_count_num = cart_count.split(' ');
							cart_count_num = cart_count_num[0];

							if ($('.header_mobile_cart .top-basket-count').length) {
								$('.header_mobile_cart .top-basket-count').html(cart_count_num);
							}
						}

						if($('.header-cart .header-cart-sum').length){
							var cart_sum = $('.header-cart .header-cart-sum').html();

							$('#header_scroll .is_cart_sum').html(cart_sum);
						}

					});
					if (!window.location.search.includes('old_header')) {
						$.get("/ajax/view/basket_top_redesign.php", function (headerBasketHtml) {
							$(".header-basket").html($(headerBasketHtml).html());

							if ($('.header-top .header-basket__quantity').length) {
								let cartItemsCount = $('.header-top .header-basket__quantity').text();
								if (!isNaN(cartItemsCount)) {
									let lastDigit = cartItemsCount % 10;
									let wordEnd = '';
									if (lastDigit > 1 && lastDigit < 5)
										wordEnd = 'а';
									else if (lastDigit > 4)
										wordEnd = 'ов';

									$('#header_scroll .is_cart_count').html(cartItemsCount + ' товар' + wordEnd);
									$('.header_mobile_cart .top-basket-count').html(cartItemsCount);
								}
							}

							if ($('.header-top .header-basket__total').length) {
								$('#header_scroll .is_cart_sum').html($('.header-top .header-basket__total').html());
							}
						});
					}
				} else {
					$.colorbox({
						html: data['message'],
						className: 'pinfo',
						initialWidth: 0,
						initialHeight: 0,
						onOpen: function () {
							$("#cboxClose").css({opacity: 0});
						},
						onComplete: function () {
							$("#cboxClose").stop().animate({opacity: 1});
						}
					});
				}
			}
		});
	}
	$(document).on('click','.header-cart a[href="/personal/cart/"],.header_mobile_cart[href="/personal/cart/"], .header-basket',function(e){
		if($(window).width()>550 || window.location.search.indexOf('new_basket')>-1){
			event.preventDefault();

			var data = {};
			if(window.location.search=='?new_basket'){
				data = {'new_basket':'.'};
			}
			if(window.location.search=='?test'){
				data = {'test':'.'};
			}
			//console.log(data);
			data = {
				window_width:$(window).width(),
				city: $('[data-role="header-city"]').text()
			};
			//console.log(data);
			$.colorbox({
				href: '/ajax/view/add2basket_popup.php',
				className: 'pforms',
				initialWidth: 0,
				initialHeight: 0,
				data: data,
				width: ($(window).width() < 1000) ? ($(window).width() - 20) + 'px' : false,
				onOpen: function () {
					$("#cboxClose").css({opacity: 0});
				},
				onComplete: function () {
					$("#cboxClose").stop().animate({opacity: 1});
					$.colorbox.resize();
				}
			});
		}
	});
	// Добавить в избранное
	$(document).on('click', '.favorites_add', function () {
		var obj = $(this);
		var fav_id = $(this).attr('id').replace('favorites_', '');
		var sec_id = $(this).attr('rel').replace('sectionid_', '');
		yaGoalsFunction.event9();
		if (obj.hasClass('change')) {
			$.get("/add_favorites.php", {element_id: fav_id, fav_section_id: sec_id, delete: true}, function (data) {
				if (data) {
//					$('#favorites_' + fav_id).removeClass('change');
//					$('#favorites_' + fav_id + ' > img').attr('src', '/images/favorite.png');
//					$('#favorites_' + fav_id).find('span').html('В избранное');
					obj.removeClass('change');
					obj.find('img').attr('src', '/images/favorite.png');
					obj.find('span').html('В избранное');
//					var countFavoriteItems = Number($(".header_fixed_block_items-favorites .count").text()) - 1;
					var countFavoriteItems = Number($(".favorites_link .count_favorite_items").html()) - 1;
					$(".header_fixed_block_items-favorites .count").text(countFavoriteItems);
                    $('.favorites_link .count_favorite_items').text(countFavoriteItems);

					$('div[data-favorites-count]').text(countFavoriteItems);

					if(countFavoriteItems <= 0)
						//$(".favorites_link").animate({'margin-right': "-40px"}, 100, function() {});
						$('.favorites_link').addClass('hidden');
				}
			});
		} else {
			$.get("/add_favorites.php", {element_id: fav_id, fav_section_id: sec_id}, function (data) {
				if (data) {
//					$('#favorites_' + fav_id).addClass('change');
//					$('#favorites_' + fav_id + ' > img').attr('src', '/images/added_favorite.png');
//					//$('.favorites_link').animate({'right': '0px'}, 'slow');
//					$('.favorites_link').removeClass('hidden');
//					$('#favorites_' + fav_id).find('span').html('В избранном');
					obj.addClass('change');
					obj.find('img').attr('src', '/images/added_favorite.png');
					//$('.favorites_link').animate({'right': '0px'}, 'slow');
					$('.favorites_link').removeClass('hidden');
					obj.find('span').html('В избранном');
//					var countFavoriteItems = Number($(".header_fixed_block_items-favorites .count").text())+ 1;
					var countFavoriteItems = Number($(".favorites_link .count_favorite_items").html())+ 1;
					$(".header_fixed_block_items-favorites .count").text(countFavoriteItems);
                    $('.favorites_link .count_favorite_items').text(countFavoriteItems);

					$('div[data-favorites-count]').text(countFavoriteItems);

					/*if(countFavoriteItems > 0)
						$(".favorites_link").animate({'margin-right': "0px"}, 100, function() {});*/
				}
			});
		}

	});
	$(document).on('click', '.favorites_add--new', function () {

		var fav_id = $(this).attr('id').replace('favorites_', '');
		var sec_id = $(this).attr('rel').replace('sectionid_', '');
		yaGoalsFunction.event9();

		if ($(this).hasClass('change')) {
			$.get("/add_favorites.php", {element_id: fav_id, fav_section_id: sec_id, delete: true}, function (data) {
				if (data) {
					//console.log(data);

					let favorites = JSON.parse(window.localStorage.getItem('favorites')) || {};
					delete favorites[fav_id];
					window.localStorage.setItem('favorites', JSON.stringify(favorites));

					favoritesSync.sync();

					$('#favorites_' + fav_id).removeClass('change');
					$('#favorites_' + fav_id + ' img').attr('src', '/images/new_favorite.png');
                    $('#favorites_' + fav_id + ' img').attr('title', 'Добавить в избранное');
					$('#favorites_' + fav_id).find('span').html('В избранном');
                    var countFavorites = Number($(".favorites_link .count_favorite_items").html()) - 1;
                    $('.favorites_link .count_favorite_items').text(countFavorites);
                    $('.top-fav .count_favorite_items').text(countFavorites);
                    if (countFavorites > 0) {
                        $(".header_fixed_block_items-favorites a .count").text(countFavorites);
                        $('.favorites_link .count_favorite_items').text(countFavorites);
					} else {
                        $(".header_fixed_block_items-favorites a .count").remove();
                        $(".header_fixed_block_items-favorites a img").removeClass("background_elliplse")
							.attr("src", "/bitrix/templates/mosoboi_ad/images/header_fixed_block/none_favorites.png");
                        $('.favorites_link').addClass('hidden');
					}

					$('div[data-favorites-count]').text(countFavorites);
				}
			});
		} else {
			$.get("/add_favorites.php", {element_id: fav_id, fav_section_id: sec_id}, function (data) {
				if (data) {
					//console.log(data);

					let favorites = JSON.parse(window.localStorage.getItem('favorites')) || {};
					favorites[fav_id] = fav_id;
					window.localStorage.setItem('favorites', JSON.stringify(favorites));

					favoritesSync.sync();

					$('#favorites_' + fav_id).addClass('change');
					$('#favorites_' + fav_id + ' img').attr('src', '/images/new_added_favorite.png');
					$('#favorites_' + fav_id + ' img').attr('title', 'Убрать из избранного');
					//$('.favorites_link').animate({'right': '0px'}, 'slow');
					$('.favorites_link').removeClass('hidden');
                    $('.favorites_link .count_favorite_items').text(countFavorites);
					$('#favorites_' + fav_id).find('span').html('В избранное');
                    var countFavorites = Number($(".favorites_link .count_favorite_items").html()) + 1;
                    $('.favorites_link .count_favorite_items').text(countFavorites);
                    $('.top-fav .count_favorite_items').text(countFavorites);

                    if(!$(".header_fixed_block_items-favorites a img").hasClass("background_elliplse")) {
                        $(".header_fixed_block_items-favorites a img")
                            .addClass("background_elliplse")
                            .attr("src", "/bitrix/templates/mosoboi_ad/images/header_fixed_block/have_numbers_favorites.png");
                        $(".header_fixed_block_items-favorites a").append("<div class='count'>" + 1 + "</div>");
                    } else {
                        $(".header_fixed_block_items-favorites a .count").text(countFavorites);
                    }

					$('div[data-favorites-count]').text(countFavorites);
				}
			});
		}
	});

    $(document).on('click', '.compare_add--new', function () {
        var com_id = $(this).attr('id').replace('compare_', '');
        var sec_id = $(this).attr('rel').replace('sectionid_', '');
        var $this = $(this);
        yaGoalsFunction.event21();


        if ($(this).hasClass('change')) {
            $.ajax({
                url: "/ajax/result/addToCompareList.php?action=DELETE_FROM_COMPARE_LIST&id=" + com_id,
                success: function (data) {
                    $('#compare_' + com_id).removeClass('change').attr("title", "Добавить к сравнению");
                    if(!$this.hasClass("btms_compare"))
                    	$('#compare_' + com_id + ' > img').attr('src', '/images/compare_not_active.png');

                    if($this.hasClass("btms_compare"))
                        $('#compare_' + com_id + " span").text("Сравнить");
                    var countCompareItems = Number($(".compare_link .count_compare_items").html()) - 1;
                    $(".compare_link .count_compare_items").text(countCompareItems);
                    $(".top-compare .count_compare_items").text(countCompareItems);
					$(".header_fixed_block_items-compare .count").text(countCompareItems);
					$(".top-compare .top-compare-count").text(countCompareItems);
					$('[data-compare-count]').text(countCompareItems);

                    if(countCompareItems === 0) {
                        $(".compare_link").addClass('hidden');
                        $(".header_fixed_block_items-compare").css("display", "none");
					}
                }
            });
        } else {
            $.ajax({
                url: "/ajax/result/addToCompareList.php?action=ADD_TO_COMPARE_LIST&id=" + com_id,
                success: function (data) {
                    $('#compare_' + com_id).addClass('change').attr("title", "В сравнении");
                    if(!$this.hasClass("btms_compare"))
                    	$('#compare_' + com_id + ' > img').attr('src', '/images/compare_active.png');
					var txt = ($(window).width() < 1000) ? 'Убрать из сравнения' : 'Убрать из<br>сравнения';
                    if($this.hasClass("btms_compare"))
                        $('#compare_' + com_id + " span").html(txt);

                    //$(".compare_link").css("margin-right", "0");
                    var countCompareItems = Number($(".compare_link .count_compare_items").html()) + 1;
                    $(".compare_link .count_compare_items").text(countCompareItems);
                    $(".compare_link").removeClass('hidden');
                    $(".header_fixed_block_items-compare").css("display", "inline-block");
                    $(".header_fixed_block_items-compare .count").text(countCompareItems);
                    $(".top-compare .count_compare_items").text(countCompareItems);
					$(".top-compare .top-compare-count").text(countCompareItems);
					$('[data-compare-count]').text(countCompareItems);
                }
            });
        }
    });

	$("a.scroll_detail").fancybox({
		helpers: {
			overlay: {locked: false},
			title:{
				type:'over'
			}
		},
		padding:'0',
		beforeShow:function () {
			var imgAlt=$(this.element).attr("data-alt");
			if (imgAlt) {
				$(".fancybox-image").attr("alt",imgAlt);
				$(".fancybox-image").attr("title",imgAlt);
				//console.log(imgAlt);
			}
		},
		afterShow: function() {
			let title = $(this.element).attr('title');
			if (title)
				$('.fancybox-title').html('<!--noindex-->' + title + '<!--/noindex-->');
		}
	});

	$("a.scroll_detail_v2").fancybox({
		helpers: {
			overlay: {
				locked: false
			},
			title: {
				type:'outside'
			}
		},
		padding:'0',
		beforeShow: function () {
			var imgAlt=$(this.element).attr("data-alt");
			if (imgAlt) {
				$(".fancybox-image").attr("alt",imgAlt);
				$(".fancybox-image").attr("title",imgAlt);
			}
		}
	});

	if (($("#breadcrumb").children().eq(2).html() !== "Zambaiti") && ($("#breadcrumb").children().eq(2).html() !== "Обои Zambaiti (Италия)")) {
		$(".float_price").css("visibility", "visible");
	}

	if($('.hits_news_tabs').length)
	{
		$('.hits_news_tabs .tab_captions .tab').on('click', function () {
			var id = $(this).attr('id');
			id = '.'+id;
			$('.hits_news_tabs .tab_captions .tab').removeClass('active');
			$(this).addClass('active');
			$('.hits_news_tabs .tab_contents .tab').removeClass('active');
			$('.hits_news_tabs .tab_contents .tab'+id).addClass('active');
		})
	}

	if($('.brands_collections_tabs').length)
	{
		brands_collections_tab_caption = $('.brands_collections_tabs .tab_captions .tab');
		brands_collections_tab_content = $('.brands_collections_tabs .tab_contents .tab');
		brands_collections_tab_caption.on('click', function () {
			var id = $(this).attr('id');
			id = '.'+id;
			brands_collections_tab_caption.removeClass('active');
			$(this).addClass('active');
			brands_collections_tab_content.removeClass('active');
			$('.brands_collections_tabs .tab_contents .tab'+id).addClass('active');
		})
	}

	/*на главной перед футером 3 блока: новости+статьи+акции должны быть одного размера (только для десктопа)*/
	blocks_main_news_articles_action();
	$(window).on('resize', function () {
		blocks_main_news_articles_action();
	});

	/* форма отправки резюме на странице /vacansii/ */
	jQuery(document).ready(function () {
		jQuery('.vacancy_feedback input[type=submit]').on('click', function(){
			//debugger;
			var name = jQuery('.vacancy_feedback input[name=name]').val();
			var email = jQuery('.vacancy_feedback input[name=email]').val();
			var phone = jQuery('.vacancy_feedback input[name=phone]').val();
			var rezume_file = jQuery('.vacancy_feedback input[name=rezume_file]');


			var fd = new FormData();
			fd.append('name', name);
			fd.append('email', email);
			fd.append('phone', phone);
			fd.append('rezume_file', rezume_file[0].files[0]);
			fd.append('rezume', 'Y');
			//debugger;

			jQuery.ajax({
				type: 'POST',
				url: '/ajax/form/rezume_form.php',
				data: fd,
				processData: false,
				contentType: false,
				dataType: 'json',
				success: function(data) {
					debugger;
					if(data.error)
					{
						jQuery('.vacancy_feedback p.error').html(data.error).show();
						jQuery('.vacancy_feedback p.success').html('').hide();
					}
					else
					{
						jQuery('.vacancy_feedback p.success').html(data.success).show();
						jQuery('.vacancy_feedback p.error').html('').hide();
						jQuery('.vacancy_feedback input:not([type=submit])').val('');
					}
				},
				error: function(data) {
					//console.log(data);
				}
			});
		});
	});
});

$(document).ready(function(){

	$('body').on('click','.js_count_plus',function(){

		var obj = $(this);
		var price = obj.closest('form').find('.js_product_price').val().replace(' ','');
		var count_input = obj.closest('form').find('.count_input');
		var count = parseInt(obj.closest('form').find('.count_input').val())+1;
		var summa = number_format((price*count), 0, '.', ' ');
		count_input.val(count)
		obj.closest('form').find('.js_price').html(summa);
		obj.closest('form').find('.js_price_input').val(summa);


		if(obj.closest('.add2basket-popup').find('.add2basket').length>0){
			obj.closest('.add2basket-popup').find('.add2basket').show();
			obj.closest('.add2basket-popup').find('.js_btn_green2').hide();
		}
	});
	$('body').on('click','.js_count_minus',function(){

		var obj = $(this);
		var price = obj.closest('form').find('.js_product_price').val().replace(' ','');
		var count_input = obj.closest('form').find('.count_input');
		var count = parseInt(obj.closest('form').find('.count_input').val())-1;
		if(count<=0){
			count = 1;
		}
		var summa = number_format((price*count), 0, '.', ' ');
		count_input.val(count);
		obj.closest('form').find('.js_price').html(summa);
		obj.closest('form').find('.js_price_input').val(summa);

	});

});

function detectmob() {
	if( navigator.userAgent.match(/Android/i)
		|| navigator.userAgent.match(/webOS/i)
		|| navigator.userAgent.match(/iPhone/i)
		|| navigator.userAgent.match(/iPad/i)
		|| navigator.userAgent.match(/iPod/i)
		|| navigator.userAgent.match(/BlackBerry/i)
		|| navigator.userAgent.match(/Windows Phone/i)
		|| navigator.userAgent.match(/Mobile/i)
	){
		return true;
	}
	else {
		return false;
	}
}


function blocks_main_news_articles_action() {
	blocks_selector = $('.main_news_articles_action > div');
	if(blocks_selector.length>0) {
		if ($(window).width() >= 1200) {
			blocks_height = 0;
			blocks_selector.each(function (i, el) {
				if ($(el).height() > blocks_height) {
					blocks_height = $(el).height();
				}
			});
			blocks_selector.height(blocks_height);
		}
		else {
			blocks_selector.css('height', 'auto');
		}
	}
}

function number_format( number, decimals, dec_point, thousands_sep ) {
    var i, j, kw, kd, km;

    // input sanitation & defaults
    if( isNaN(decimals = Math.abs(decimals)) ){
        decimals = 2;
    }
    if( dec_point == undefined ){
        dec_point = ",";
    }
    if( thousands_sep == undefined ){
        thousands_sep = ".";
    }

    i = parseInt(number = (+number || 0).toFixed(decimals)) + "";

    if( (j = i.length) > 3 ){
        j = j % 3;
    } else{
        j = 0;
    }

    km = (j ? i.substr(0, j) + thousands_sep : "");
    kw = i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousands_sep);
    //kd = (decimals ? dec_point + Math.abs(number - i).toFixed(decimals).slice(2) : "");
    kd = (decimals ? dec_point + Math.abs(number - i).toFixed(decimals).replace(/-/, 0).slice(2) : "");


    return km + kw + kd;
}

$(document).on('click','.js_delete',function(){
    var obj = $(this);
    var obj_item = obj.closest('.js_item');
    var obj_basket = obj.closest('.js_basket');
    var obj_top = obj.closest('.js_top');
    var obj_summ = obj_top.find('.js_summ_price');

	var data = 'mode=delete&id='+obj_item.attr("data-id");
	$.ajax({
		url: '/ajax/view/add2basket_popup/basket_item_delete.php',
		type: 'POST',
		data: data,
		success: function(answ){

			item_delete = false;

			if(answ!=='0'){
				item_delete = true;
			}
			if(answ=='0'){
				if(obj_basket.find('.js_item').length==1){
					item_delete = true;
					//obj_basket.html("<h2>Корзина пуста</h2>");
				}
			}

			if(item_delete){
				obj_item.remove();
				obj_summ.attr('data-summ',answ);
				obj_summ.html(number_format(answ,0,',',' '));

				popupDeliveryBlockUpdate(answ);
				//console.log('answ', answ);
			}

			//если для сопутствующего товара нет основного - удаляем сопутствующий товар
			document.querySelectorAll('[data-soput-for]').forEach((soputItem) => {
				let mainProductId = soputItem.dataset.soputFor;
				if (document.querySelectorAll(`[data-iblock="${mainProductId}"]`).length == 0)
					soputItem.remove();
			});

			//если сопутствующих товаров нет - удаляем блок "Сопутствующие товары"
			let soputCount = document.querySelectorAll('.soput_block .sl_item').length;
			if (soputCount == 0 && document.querySelector('.soput_block'))
				document.querySelector('.soput_block').remove();

			// if (document.querySelectorAll('[data-iblock="3"]').length == 0) {
			// 	document.querySelectorAll('.soput_block [data-soput-type="glue"]')
			// 		.forEach(item => item.remove());
			//
			// 	let soputCount = document.querySelectorAll('.soput_block .sl_item').length;
			//
			// 	if (soputCount == 0 && document.querySelector('.soput_block'))
			// 		document.querySelector('.soput_block').remove();
			// }

		}
	});
});
$(document).on('click','.js_count_btn',function(){
    var obj = $(this);
    var mode = obj.attr("data-mode");
    var obj_item = obj.closest('.js_item');
    var obj_type = obj_item.attr('data-type');
    var obj_count = obj_item.find('.js_count_num');

    //console.log(obj_type);
    //console.log(mode);
    if(obj_type=='soput'){
    	var count_num = parseInt(obj_count.html());
		if(mode=='plus'){
			count_num += 1;
		} else if(mode=='minus'){
			count_num -= 1;
		}
	    //console.log(count_num);
	    if(count_num>0){
			obj_count.html(count_num);
			obj_item.find('.js_count_input').val(count_num);
	    }
    }
    if(obj_type=='basket'){
        var price = parseInt(obj_count.attr('data-price'));
        var obj_top = obj.closest('.js_top');
        var obj_summ = obj_top.find('.js_summ_price');
        var summ = parseInt(obj_summ.attr('data-summ'));

		//расчет суммы не дожидаясь ответа от бэкэнда
		let productsCount = parseInt(obj_count.html());

		if (mode == 'plus') {
			productsCount++;
			summ += price;
		} else if (mode == 'minus' && productsCount > 1) {
			productsCount--;
			summ -= price;
		}

		// console.log('price', price);
		// console.log('summ', summ);

		obj_count.html(productsCount);

		obj_summ.attr('data-summ',summ);
		obj_summ.html(number_format(summ,0,',',' '));

		popupDeliveryBlockUpdate(summ);

		//console.log(summ);

    	var data = 'mode='+mode+'&id='+obj_item.attr("data-id");
    	$.ajax({
    		url: '/ajax/view/add2basket_popup/basket_item_count.php',
    		type: 'POST',
    		data: data,
    		success: function(answ){

				$.ajax({
					url: '/ajax/cart/glueCalculate.php',
					type: 'GET',
					dataType: 'json',
					success: function(response) {
						if (response.glues) {
							let totalGluesQuantity = 0;
							for (let id in response.glues) {
								$('.sl_item[data-element-id="' + id + '"] .js_count_input').val(response.glues[id]['RECOMENDED_QUANTITY']);
								$('.sl_item[data-element-id="' + id + '"] .js_count_num').text(response.glues[id]['RECOMENDED_QUANTITY']);

								totalGluesQuantity += +response.glues[id]['RECOMENDED_QUANTITY'];
							}


							$('[data-role="soput-quantity"]').text(totalGluesQuantity + ' ' + num_word(totalGluesQuantity, ['пачка', 'пачки', 'пачек']));
						}
						console.log(response);
					}
				});


				//рачет суммы используя ответ от бэкэнда
    			// if(answ!=='0'){
    			// 	obj_count.html(answ);
				//
    			// 	if(mode=='plus'){
    			// 		summ += parseInt(price);
    			// 	} else if(mode=='minus'){
    			// 		summ -= price;
    			// 	}
				//
    			// 	obj_summ.attr('data-summ',summ);
    			// 	obj_summ.html(number_format(summ,0,',',' '));
    			// }
    		}
    	});
    }
});

function num_word(value, words){
	value = Math.abs(value) % 100;
	var num = value % 10;
	if(value > 10 && value < 20) return words[2];
	if(num > 1 && num < 5) return words[1];
	if(num == 1) return words[0];
	return words[2];
}

function popupDeliveryBlockUpdate(orderPrice) {
	let popupDeliveryTitle = document.querySelector('[data-role="popup-delivery-title"]');
	let popupDeliveryText = document.querySelector('[data-role="popup-delivery-text"]');

	if (popupDeliveryTitle && popupDeliveryText) {
		if (orderPrice > 15000) {
			popupDeliveryTitle.innerHTML = 'Доставка этого заказа<br>будет бесплатной';
			popupDeliveryText.innerHTML = '';
		} else {
			popupDeliveryTitle.innerHTML = 'Бесплатная доставка при заказе от 15000р.';
			popupDeliveryText.innerHTML = `Дополните свой заказ на <span>${15000 - orderPrice}р</span> чтобы получить бесплатную доставку`;
		}
	}
}

$(document).on('click','.showformlink',function(){
	var obj = $(this);
	if(obj.closest('.title-search-result').length>0){

		var search_query = obj.closest('.js_container').find('.js_search_query').html();
		$.colorbox({
			href: '/ajax/form/poisk_title.php',
			data: {
				'search_query': search_query,
			},
			className: 'pforms',
			initialWidth: 0,
			initialHeight: 0,
			onOpen: function () {
				$("#cboxClose").css({opacity: 0});
			},
			onComplete: function () {
				$("#cboxClose").stop().animate({opacity: 1});
			}
		});
	}

});

$(document).on('click','.marquiz-pops__close',function() {
	document.cookie = 'notShowQuiz=1';
});

$(document).ready(function() {
	if (document.cookie.includes('notShowQuiz') && window.innerWidth < 900) {
		if (document.querySelector('.quiz-message')) {
			document.querySelector('.quiz-message').remove();
			//console.log('marquiz removed');
		}
	}
});

document.addEventListener('DOMContentLoaded', () => {
	if (document.querySelector('.bx-sidebar-block')) {
		document.body.classList.add('has-side-block');
	}
});


$(document).ready(function() {
	$('.uw-widget .whatsapp').click(function() {
		ym(15883444, 'reachGoal', 'micro_click_whatsapp');
	});

	$(document).on('click', '.marquiz-pops__body', function() {
		ym(15883444, 'reachGoal', 'micro_click_podbor_online');
	});
});

document.addEventListener('DOMContentLoaded', () => {
	let catalogPhraseContainer = document.querySelector('.catalog-phrase-container');
	if (catalogPhraseContainer) {
		catalogPhraseContainer.innerHTML = `
		<!--noindex-->
		<div class="catalog-phrase">
		В связи с услугой <a href="/uslugi/katalog_pod_zalog/">"каталог под залог"</a>, перед посещением нашего шоу-рума, просим Вас связаться с менеджером для уточнения наличия интересующей Вас коллекции. Телефон <a href="tel:+74952553424" class="ya-phone-1">+7 (495) 255-34-24</a>.
		</div>
		<!--/noindex-->
		`;
	}
});


document.addEventListener('DOMContentLoaded', () => {
	let favorites = JSON.parse(window.localStorage.getItem('favorites')) || {};
	let favoritesCount = Object.keys(favorites).length;

	//старая шапка
	document.querySelectorAll('.count_favorite_items').forEach((headerFavoritesCount) => {
		headerFavoritesCount.innerText = favoritesCount;
	});

	//новая шапка
	document.querySelectorAll('div[data-favorites-count]').forEach((headerFavoritesCount) => {
		headerFavoritesCount.innerText = favoritesCount;
	});

	for (let id in favorites) {
		let favoriteElement = document.querySelector('#favorites_' + favorites[id]);
		if (favoriteElement)
			favoriteElement.classList.add('change');
	}
});


let favoritesSync = {
	sync: () => {
		let data= {
			favorites: window.localStorage.getItem('favorites') || '',
		}

		fetch('/ajax/favorites/save_to_session.php', {
			method: 'POST',
			body: JSON.stringify(data),
			headers: {
				'Content-type': 'application/json; charset=UTF-8',
			},
		})
			.then((response) => response.json())
			.then((data) => {
				// console.log(data);
			});
	}
}

favoritesSync.sync();

let popupCartSoputSuggestion = {
	init: () => {
		popupCartSoputSuggestion.form = document.querySelector('[data-role="soput-suggestion"]');
		popupCartSoputSuggestion.closeBtns = document.querySelectorAll('[data-role="soput-suggestion-close"]');
		popupCartSoputSuggestion.confirmBtn = document.querySelector('[data-role="soput-suggestion-confirm"]');

		if (!popupCartSoputSuggestion.form || !popupCartSoputSuggestion.closeBtns || !popupCartSoputSuggestion.confirmBtn)
			return false;

		popupCartSoputSuggestion.closeBtns.forEach((closeBtn) => {
			closeBtn.addEventListener('click', popupCartSoputSuggestion.close);
		});
		popupCartSoputSuggestion.confirmBtn.addEventListener('click', popupCartSoputSuggestion.confirm);
	},
	close: () => {
		popupCartSoputSuggestion.form.remove();
		console.log('close');
	},
	confirm: () => {
		let basket = popupCartSoputSuggestion.form.closest('.basket_right');
		if (!basket)
			return false;

		basket.querySelectorAll('[data-role="cart-soput-buy"]').forEach((buyBtn) => buyBtn.click());
	}
}

document.addEventListener('DOMContentLoaded', () => {
	$('.available-hint__btn').mouseover(function() {
		let container = $(this).closest('.available-hint').find('.available-hint__message');
		$.ajax({
			url: '/ajax/messages/availableHint.php',
			method: 'POST',
			dataType: 'json',
			success: function(response) {
				container.text(response.text);
				console.log(response.text);
			}
		});
	});
});


document.addEventListener('DOMContentLoaded', () => {
	fetch('/ajax/cart/get_price.php')
		.then((response) => response.json())
		.then((data) => {
			if (data.price)
				$('.header-basket__total').html(data.price + ' р.');
		});
});


// $(document).ready(function() {
// 	$('.read-more-wrap a').click(function(e) {
// 		e.preventDefault();
//
// 		const stickHeaderHeight = 70;
// 		const compilationsHeaderHeight = 50;
//
// 		let addVerticalOffset = stickHeaderHeight + 30;
// 		if ($('.compilation_head_fixed').length > 0)
// 			addVerticalOffset += compilationsHeaderHeight;
//
// 		console.log($('.compilation_head_fixed').length);
// 		console.log(addVerticalOffset);
//
// 		$('html, body').animate({
// 			scrollTop: $("#text_after_products").offset().top - addVerticalOffset
// 		}, 500);
// 	});
// });

